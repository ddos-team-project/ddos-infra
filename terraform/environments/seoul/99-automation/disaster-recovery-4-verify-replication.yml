description: "[Failback 5/6] Seoul 리전에서 실행 - Global Cluster 복제 검증 및 페일백 완료"
schemaVersion: "0.3"
assumeRole: "{{ AutomationAssumeRole }}"

parameters:
  GlobalClusterIdentifier:
    type: String
    description: "(필수) Global Cluster ID"
    default: "dh-prod-global-rds-v2"
  SeoulClusterIdentifier:
    type: String
    description: "(필수) Seoul 클러스터 ID (현재 Secondary)"
    default: "dh-prod-db-seoul-aurora-recovered"
  TokyoEndpoint:
    type: String
    description: "(필수) Tokyo Primary 엔드포인트 (disaster-recovery-prepare-failback 출력값)"
    default: ""
  TokyoReaderEndpoint:
    type: String
    description: "(필수) Tokyo Reader 엔드포인트 (disaster-recovery-prepare-failback 출력값)"
    default: ""
  MaxReplicationLagSeconds:
    type: Integer
    description: "(필수) 허용 가능한 최대 복제 지연 (초)"
    default: 5
  IncidentNumber:
    type: String
    description: "(필수) 장애 관리 번호"
    default: ""
  AutomationAssumeRole:
    type: String
    description: "(선택) Automation 실행 IAM Role ARN"
    default: ""

mainSteps:
  - name: LogVerifyStart
    action: aws:executeAwsApi
    description: "복제 검증 시작 기록"
    inputs:
      Service: cloudwatch
      Api: PutMetricData
      Namespace: "Aurora/DisasterRecovery"
      MetricData:
        - MetricName: "FailbackVerifyReplicationStarted"
          Value: 1
          Unit: "Count"
          Dimensions:
            - Name: "Phase"
              Value: "VerifyReplication"
            - Name: "IncidentNumber"
              Value: "{{ IncidentNumber }}"

  - name: VerifyGlobalClusterHealth
    action: aws:executeAwsApi
    description: "Global Cluster 상태 확인"
    inputs:
      Service: rds
      Api: DescribeGlobalClusters
      GlobalClusterIdentifier: "{{ GlobalClusterIdentifier }}"
    outputs:
      - Name: GlobalClusterStatus
        Selector: "$.GlobalClusters[0].Status"
        Type: String
      - Name: Engine
        Selector: "$.GlobalClusters[0].Engine"
        Type: String
      - Name: PrimaryClusterArn
        Selector: "$.GlobalClusters[0].GlobalClusterMembers[?(@.IsWriter==true)].DBClusterArn"
        Type: String

  - name: VerifySeoulSecondaryStatus
    action: aws:executeAwsApi
    description: "Seoul Secondary 클러스터 상태 확인"
    inputs:
      Service: rds
      Api: DescribeDBClusters
      DBClusterIdentifier: "{{ SeoulClusterIdentifier }}"
    outputs:
      - Name: SeoulStatus
        Selector: "$.DBClusters[0].Status"
        Type: String
      - Name: SeoulReaderEndpoint
        Selector: "$.DBClusters[0].ReaderEndpoint"
        Type: String

  - name: CheckReplicationLag
    action: aws:executeAwsApi
    description: "Seoul Secondary 복제 지연 확인"
    onFailure: Continue
    inputs:
      Service: cloudwatch
      Api: GetMetricStatistics
      Namespace: "AWS/RDS"
      MetricName: "AuroraGlobalDBReplicationLag"
      Dimensions:
        - Name: DBClusterIdentifier
          Value: "{{ SeoulClusterIdentifier }}"
      StartTime: "{{ global:DATE_TIME }}"
      EndTime: "{{ global:DATE_TIME }}"
      Period: 60
      Statistics:
        - Average
        - Maximum

  - name: VerifyReplicationConnectivity
    action: aws:executeAwsApi
    description: "Global Cluster 멤버 연결 상태 확인"
    inputs:
      Service: rds
      Api: DescribeGlobalClusters
      GlobalClusterIdentifier: "{{ GlobalClusterIdentifier }}"
    outputs:
      - Name: VerifiedPrimaryArn
        Selector: "$.GlobalClusters[0].GlobalClusterMembers[?(@.IsWriter==true)].DBClusterArn"
        Type: String

  - name: CheckSeoulReaderInstances
    action: aws:executeAwsApi
    description: "Seoul Reader 인스턴스 상태 확인"
    inputs:
      Service: rds
      Api: DescribeDBInstances
      Filters:
        - Name: "db-cluster-id"
          Values:
            - "{{ SeoulClusterIdentifier }}"

  - name: UpdateSSMWriterEndpoint
    action: aws:executeAwsApi
    description: "Writer 엔드포인트 SSM 업데이트 (Tokyo)"
    inputs:
      Service: ssm
      Api: PutParameter
      Name: "/ddos/aurora/cluster_endpoint"
      Value: "{{ TokyoEndpoint }}"
      Type: "String"
      Overwrite: true
      Description: "Aurora Primary Writer Endpoint (Tokyo after failback)"

  - name: UpdateSSMReaderEndpoint
    action: aws:executeAwsApi
    description: "Reader 엔드포인트 SSM 업데이트 (Tokyo)"
    inputs:
      Service: ssm
      Api: PutParameter
      Name: "/ddos/aurora/cluster_reader_endpoint"
      Value: "{{ TokyoReaderEndpoint }}"
      Type: "String"
      Overwrite: true

  - name: CreateFailbackCompletionAlarm
    action: aws:executeAwsApi
    description: "페일백 완료 모니터링 알람 생성"
    inputs:
      Service: cloudwatch
      Api: PutMetricAlarm
      AlarmName: "aurora-failback-replication-lag"
      AlarmDescription: "Seoul Secondary 복제 지연 모니터링"
      ActionsEnabled: true
      MetricName: "AuroraGlobalDBReplicationLag"
      Namespace: "AWS/RDS"
      Statistic: "Average"
      Period: 300
      EvaluationPeriods: 2
      Threshold: 10000
      ComparisonOperator: "GreaterThanThreshold"
      Dimensions:
        - Name: DBClusterIdentifier
          Value: "{{ SeoulClusterIdentifier }}"

  - name: LogVerifyComplete
    action: aws:executeAwsApi
    description: "복제 검증 완료 기록"
    inputs:
      Service: cloudwatch
      Api: PutMetricData
      Namespace: "Aurora/DisasterRecovery"
      MetricData:
        - MetricName: "FailbackVerifyReplicationCompleted"
          Value: 1
          Unit: "Count"
          Dimensions:
            - Name: "Phase"
              Value: "VerifyReplication"
            - Name: "IncidentNumber"
              Value: "{{ IncidentNumber }}"

  - name: LogFailbackComplete
    action: aws:executeAwsApi
    description: "페일백 전체 프로세스 완료 기록"
    inputs:
      Service: cloudwatch
      Api: PutMetricData
      Namespace: "Aurora/DisasterRecovery"
      MetricData:
        - MetricName: "FailbackCompleted"
          Value: 1
          Unit: "Count"
          Dimensions:
            - Name: "IncidentNumber"
              Value: "{{ IncidentNumber }}"

  - name: CreateFinalAuditRecord
    action: aws:executeAwsApi
    description: "최종 감사 로그 생성"
    inputs:
      Service: ssm
      Api: PutParameter
      Name: "/ddos/aurora/disaster-recovery/failback-complete-{{ global:DATE }}"
      Value: "Incident: {{ IncidentNumber }}, Global Cluster: {{ GlobalClusterIdentifier }}, Primary: Tokyo, Secondary: Seoul, Status: Active, Completion Time: {{ global:DATE_TIME }}"
      Type: "String"
      Overwrite: true
      Description: "Disaster Recovery Failback Completion Audit"

outputs:
  - VerifyGlobalClusterHealth.GlobalClusterStatus
  - VerifyGlobalClusterHealth.PrimaryClusterArn
  - VerifySeoulSecondaryStatus.SeoulStatus
  - VerifySeoulSecondaryStatus.SeoulReaderEndpoint
