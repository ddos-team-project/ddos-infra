description: "[Failback 4/6] Seoul 리전에서 실행 - Seoul 클러스터를 Global Cluster Secondary로 추가"
schemaVersion: "0.3"
assumeRole: "{{ AutomationAssumeRole }}"

parameters:
  GlobalClusterIdentifier:
    type: String
    description: "(필수) Global Cluster ID (disaster-recovery-recreate-global에서 생성됨)"
    default: "dh-prod-global-rds-v2"
  SeoulClusterIdentifier:
    type: String
    description: "(필수) Seoul 클러스터 ID (Secondary가 될 클러스터)"
    default: "dh-prod-db-seoul-aurora-recovered"
  IncidentNumber:
    type: String
    description: "(필수) 장애 관리 번호"
    default: ""
  AutomationAssumeRole:
    type: String
    description: "(선택) Automation 실행 IAM Role ARN"
    default: ""

mainSteps:
  - name: LogAddSecondaryStart
    action: aws:executeAwsApi
    description: "Secondary 추가 시작 기록"
    inputs:
      Service: cloudwatch
      Api: PutMetricData
      Namespace: "Aurora/DisasterRecovery"
      MetricData:
        - MetricName: "FailbackAddSecondaryStarted"
          Value: 1
          Unit: "Count"
          Dimensions:
            - Name: "Phase"
              Value: "AddSecondary"
            - Name: "IncidentNumber"
              Value: "{{ IncidentNumber }}"

  - name: VerifySeoulClusterReady
    action: aws:executeAwsApi
    description: "Seoul 클러스터 준비 상태 확인"
    inputs:
      Service: rds
      Api: DescribeDBClusters
      DBClusterIdentifier: "{{ SeoulClusterIdentifier }}"
    outputs:
      - Name: SeoulStatus
        Selector: "$.DBClusters[0].Status"
        Type: String
      - Name: SeoulArn
        Selector: "$.DBClusters[0].DBClusterArn"
        Type: String

  - name: VerifyGlobalClusterExists
    action: aws:executeAwsApi
    description: "Global Cluster 존재 및 상태 확인"
    inputs:
      Service: rds
      Api: DescribeGlobalClusters
      GlobalClusterIdentifier: "{{ GlobalClusterIdentifier }}"
    outputs:
      - Name: GlobalClusterStatus
        Selector: "$.GlobalClusters[0].Status"
        Type: String
      - Name: PrimaryClusterArn
        Selector: "$.GlobalClusters[0].GlobalClusterMembers[?(@.IsWriter==true)].DBClusterArn"
        Type: String

  - name: AddSeoulAsSecondary
    action: aws:executeAwsApi
    description: "Seoul 클러스터를 Global Cluster Secondary로 추가"
    inputs:
      Service: rds
      Api: ModifyDBCluster
      DBClusterIdentifier: "{{ SeoulClusterIdentifier }}"
      GlobalClusterIdentifier: "{{ GlobalClusterIdentifier }}"
      ApplyImmediately: true

  - name: WaitForSeoulSecondaryReady
    action: aws:waitForAwsResourceProperty
    description: "Seoul Secondary 추가 완료 대기"
    timeoutSeconds: 1800
    inputs:
      Service: rds
      Api: DescribeDBClusters
      DBClusterIdentifier: "{{ SeoulClusterIdentifier }}"
      PropertySelector: "$.DBClusters[0].Status"
      DesiredValues:
        - "available"

  - name: VerifyGlobalClusterSetup
    action: aws:executeAwsApi
    description: "Global Cluster 구성 확인 (Tokyo Primary + Seoul Secondary)"
    inputs:
      Service: rds
      Api: DescribeGlobalClusters
      GlobalClusterIdentifier: "{{ GlobalClusterIdentifier }}"
    outputs:
      - Name: GlobalClusterStatus
        Selector: "$.GlobalClusters[0].Status"
        Type: String
      - Name: MemberCount
        Selector: "$.GlobalClusters[0].GlobalClusterMembers[0].DBClusterArn"
        Type: String

  - name: CheckInitialReplicationLag
    action: aws:executeAwsApi
    description: "초기 복제 지연 확인"
    onFailure: Continue
    inputs:
      Service: cloudwatch
      Api: GetMetricStatistics
      Namespace: "AWS/RDS"
      MetricName: "AuroraGlobalDBReplicationLag"
      Dimensions:
        - Name: DBClusterIdentifier
          Value: "{{ SeoulClusterIdentifier }}"
      StartTime: "{{ global:DATE_TIME }}"
      EndTime: "{{ global:DATE_TIME }}"
      Period: 60
      Statistics:
        - Average

  - name: LogAddSecondaryComplete
    action: aws:executeAwsApi
    description: "Secondary 추가 완료 기록"
    inputs:
      Service: cloudwatch
      Api: PutMetricData
      Namespace: "Aurora/DisasterRecovery"
      MetricData:
        - MetricName: "FailbackAddSecondaryCompleted"
          Value: 1
          Unit: "Count"
          Dimensions:
            - Name: "Phase"
              Value: "AddSecondary"
            - Name: "IncidentNumber"
              Value: "{{ IncidentNumber }}"

  - name: CreateAddSecondaryAudit
    action: aws:executeAwsApi
    description: "Secondary 추가 감사 로그"
    inputs:
      Service: ssm
      Api: PutParameter
      Name: "/ddos/aurora/disaster-recovery/failback-add-secondary-{{ global:DATE }}"
      Value: "Global Cluster: {{ GlobalClusterIdentifier }}, Seoul Secondary Added: {{ SeoulClusterIdentifier }}, Status: {{ VerifyGlobalClusterSetup.GlobalClusterStatus }}, Incident: {{ IncidentNumber }}"
      Type: "String"
      Overwrite: true
      Description: "Failback Add Secondary Audit - Seoul"

outputs:
  - VerifyGlobalClusterSetup.GlobalClusterStatus
  - VerifySeoulClusterReady.SeoulArn
