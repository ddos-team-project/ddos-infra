description: "[Failback 0/6] Tokyo 리전에서 실행 - Seoul 복구 후 페일백 준비: 스냅샷 생성 및 정보 수집"
schemaVersion: "0.3"
assumeRole: "{{ AutomationAssumeRole }}"

parameters:
  TokyoClusterIdentifier:
    type: String
    description: "(필수) Tokyo 독립 운영 클러스터 ID"
    default: "dh-prod-db-tokyo-aurora-secondary-v2"
  IncidentNumber:
    type: String
    description: "(필수) 장애 관리 번호"
    default: ""
  AutomationAssumeRole:
    type: String
    description: "(선택) Automation 실행 IAM Role ARN"
    default: ""

mainSteps:
  - name: LogPrepareStart
    action: aws:executeAwsApi
    description: "페일백 준비 시작 기록"
    inputs:
      Service: cloudwatch
      Api: PutMetricData
      Namespace: "Aurora/DisasterRecovery"
      MetricData:
        - MetricName: "FailbackPrepareStarted"
          Value: 1
          Unit: "Count"
          Dimensions:
            - Name: "Phase"
              Value: "Prepare"
            - Name: "IncidentNumber"
              Value: "{{ IncidentNumber }}"

  - name: VerifyTokyoClusterHealth
    action: aws:executeAwsApi
    description: "Tokyo 독립 운영 클러스터 상태 확인"
    inputs:
      Service: rds
      Api: DescribeDBClusters
      DBClusterIdentifier: "{{ TokyoClusterIdentifier }}"
    outputs:
      - Name: ClusterStatus
        Selector: "$.DBClusters[0].Status"
        Type: String
      - Name: ClusterArn
        Selector: "$.DBClusters[0].DBClusterArn"
        Type: String
      - Name: ClusterEndpoint
        Selector: "$.DBClusters[0].Endpoint"
        Type: String
      - Name: ReaderEndpoint
        Selector: "$.DBClusters[0].ReaderEndpoint"
        Type: String
      - Name: Engine
        Selector: "$.DBClusters[0].Engine"
        Type: String
      - Name: EngineVersion
        Selector: "$.DBClusters[0].EngineVersion"
        Type: String
      - Name: StorageEncrypted
        Selector: "$.DBClusters[0].StorageEncrypted"
        Type: String

  - name: CreatePreFailbackSnapshot
    action: aws:executeAwsApi
    description: "페일백 전 Tokyo 최신 스냅샷 생성"
    inputs:
      Service: rds
      Api: CreateDBClusterSnapshot
      DBClusterSnapshotIdentifier: "dh-prod-tokyo-pre-failback-{{ global:DATE }}"
      DBClusterIdentifier: "{{ TokyoClusterIdentifier }}"
      Tags:
        - Key: Purpose
          Value: "FailbackPreparation"
        - Key: IncidentNumber
          Value: "{{ IncidentNumber }}"
        - Key: Phase
          Value: "PreFailback"
    outputs:
      - Name: SnapshotArn
        Selector: "$.DBClusterSnapshot.DBClusterSnapshotArn"
        Type: String

  - name: WaitForSnapshotAvailable
    action: aws:waitForAwsResourceProperty
    description: "스냅샷 생성 완료 대기"
    timeoutSeconds: 3600
    inputs:
      Service: rds
      Api: DescribeDBClusterSnapshots
      DBClusterSnapshotIdentifier: "dh-prod-tokyo-pre-failback-{{ global:DATE }}"
      PropertySelector: "$.DBClusterSnapshots[0].Status"
      DesiredValues:
        - "available"

  - name: GetSnapshotDetails
    action: aws:executeAwsApi
    description: "생성된 스냅샷 상세 정보 조회"
    inputs:
      Service: rds
      Api: DescribeDBClusterSnapshots
      DBClusterSnapshotIdentifier: "dh-prod-tokyo-pre-failback-{{ global:DATE }}"
    outputs:
      - Name: SnapshotId
        Selector: "$.DBClusterSnapshots[0].DBClusterSnapshotIdentifier"
        Type: String
      - Name: SnapshotArn
        Selector: "$.DBClusterSnapshots[0].DBClusterSnapshotArn"
        Type: String

  - name: StoreFailbackInfo
    action: aws:executeAwsApi
    description: "페일백 정보를 SSM Parameter에 저장 (서울에서 참조용)"
    inputs:
      Service: ssm
      Api: PutParameter
      Name: "/ddos/aurora/disaster-recovery/failback-info"
      Value: "SnapshotId={{ GetSnapshotDetails.SnapshotId }},ClusterArn={{ VerifyTokyoClusterHealth.ClusterArn }},Engine={{ VerifyTokyoClusterHealth.Engine }},EngineVersion={{ VerifyTokyoClusterHealth.EngineVersion }},Endpoint={{ VerifyTokyoClusterHealth.ClusterEndpoint }},ReaderEndpoint={{ VerifyTokyoClusterHealth.ReaderEndpoint }}"
      Type: "String"
      Overwrite: true
      Description: "Tokyo cluster info for Seoul failback (Incident: {{ IncidentNumber }})"

  - name: LogPrepareComplete
    action: aws:executeAwsApi
    description: "페일백 준비 완료 기록"
    inputs:
      Service: cloudwatch
      Api: PutMetricData
      Namespace: "Aurora/DisasterRecovery"
      MetricData:
        - MetricName: "FailbackPrepareCompleted"
          Value: 1
          Unit: "Count"
          Dimensions:
            - Name: "Phase"
              Value: "Prepare"
            - Name: "IncidentNumber"
              Value: "{{ IncidentNumber }}"

  - name: CreatePrepareAudit
    action: aws:executeAwsApi
    description: "준비 작업 감사 로그"
    inputs:
      Service: ssm
      Api: PutParameter
      Name: "/ddos/aurora/disaster-recovery/prepare-{{ global:DATE }}"
      Value: "Incident: {{ IncidentNumber }}, Snapshot: {{ GetSnapshotDetails.SnapshotId }}, Tokyo Cluster: {{ TokyoClusterIdentifier }}, Status: Ready for Failback, Time: {{ global:DATE_TIME }}"
      Type: "String"
      Overwrite: true
      Description: "Failback Preparation Audit - Tokyo"

outputs:
  - GetSnapshotDetails.SnapshotId
  - GetSnapshotDetails.SnapshotArn
  - VerifyTokyoClusterHealth.ClusterArn
  - VerifyTokyoClusterHealth.Engine
  - VerifyTokyoClusterHealth.EngineVersion
  - VerifyTokyoClusterHealth.ClusterEndpoint
  - VerifyTokyoClusterHealth.ReaderEndpoint
