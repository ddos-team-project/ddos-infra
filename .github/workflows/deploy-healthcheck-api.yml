name: Deploy Healthcheck API to EC2

on:
  # PR이 main으로 merge되면 자동 배포
  push:
    branches: [ main ]
    paths:
      - 'applications/healthcheck-api/**'
      - '.github/workflows/deploy-healthcheck-api.yml'
  
  # PR 생성/업데이트 시 빌드만 테스트
  pull_request:
    branches: [ main ]
    paths:
      - 'applications/healthcheck-api/**'
  
  # 수동 배포도 가능하도록 설정
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: dh-prod-t1-ecr-healthcheck-api
  IMAGE_TAG: dev
  APP_DIR: applications/healthcheck-api

jobs:
  build-test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build Docker image (test only)
      run: |
        cd ${{ env.APP_DIR }}
        docker build -t healthcheck-api:test .
        echo "✅ Build successful"

  deploy:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push image to ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      run: |
        cd ${{ env.APP_DIR }}
        IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        
        echo "Building Docker image..."
        docker build -t $IMAGE_URI .
        
        echo "Pushing to ECR..."
        docker push $IMAGE_URI
        
        echo "image=$IMAGE_URI" >> $GITHUB_OUTPUT

    - name: Deploy to EC2 (Amazon Linux)
      env:
        EC2_HOST: ${{ secrets.SEOUL_EC2_HOST }}
        SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        IMAGE_URI: ${{ steps.build-image.outputs.image }}
        AURORA_HOST: ${{ secrets.AURORA_HOST }}
        AURORA_PASSWORD: ${{ secrets.AURORA_PASSWORD }}
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      run: |
        # SSH 키 설정
        echo "$SSH_KEY" > key.pem
        chmod 600 key.pem
        
        # Amazon Linux EC2에 배포
        ssh -o StrictHostKeyChecking=no -i key.pem ec2-user@$EC2_HOST << 'ENDSSH'
          set -e
          
          echo "===== Environment: Amazon Linux ====="
          cat /etc/os-release | grep PRETTY_NAME
          
          echo "===== ECR 로그인 ====="
          aws ecr get-login-password --region ap-northeast-2 | \
            docker login --username AWS --password-stdin $ECR_REGISTRY
          
          echo "===== 최신 이미지 Pull ====="
          docker pull $IMAGE_URI
          
          echo "===== 기존 컨테이너 중지 ====="
          docker stop healthcheck-api 2>/dev/null || echo "No container to stop"
          docker rm healthcheck-api 2>/dev/null || echo "No container to remove"
          
          echo "===== 새 컨테이너 실행 ====="
          docker run -d \
            --name healthcheck-api \
            --restart unless-stopped \
            -p 8080:3000 \
            -e SERVICE_NAME='ddos-healthcheck-api' \
            -e REGION='seoul' \
            -e APP_ENV='prod' \
            -e DB_HOST='$AURORA_HOST' \
            -e DB_PORT='3306' \
            -e DB_NAME='ddos_noncore' \
            -e DB_USER='app_admin' \
            -e DB_PASSWORD='$AURORA_PASSWORD' \
            $IMAGE_URI
          
          echo "===== 컨테이너 시작 대기 (10초) ====="
          sleep 10
          
          echo "===== 컨테이너 상태 확인 ====="
          if docker ps | grep -q healthcheck-api; then
            echo "✅ Container is running"
            docker ps | grep healthcheck-api
          else
            echo "❌ Container is not running"
            docker logs --tail 30 healthcheck-api
            exit 1
          fi
          
          echo "===== 헬스체크 ====="
          if curl -f http://localhost:8080/health; then
            echo ""
            echo "✅ Deployment successful!"
          else
            echo ""
            echo "❌ Health check failed!"
            docker logs --tail 50 healthcheck-api
            exit 1
          fi
        ENDSSH
        
        rm -f key.pem
